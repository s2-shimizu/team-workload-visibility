<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒ çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/realtime.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ¯ ãƒãƒ¼ãƒ çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div class="header-right">
                <span id="connectionStatus" class="connection-status">ğŸ”´ æ¥ç¶šä¸­...</span>
                <span id="userInfo" class="user-info"></span>
                <button id="logoutBtn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <nav class="nav">
                <button class="nav-btn active" data-tab="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                <button class="nav-btn" data-tab="report">æ—¥å ±æŠ•ç¨¿</button>
                <button class="nav-btn" data-tab="calendar">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
            </nav>
        </header>

        <main class="main">
            <div class="dashboard-grid">
                <!-- è² è·çŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="workload-status">
                    <div class="section-header">
                        <h2>âš¡ ãƒãƒ¼ãƒ è² è·çŠ¶æ³</h2>
                        <button id="updateWorkloadBtn" class="update-btn">è² è·çŠ¶æ³ã‚’æ›´æ–°</button>
                    </div>
                    <div class="workload-cards" id="workloadStatusCards">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </section>

                <!-- å›°ã‚Šã”ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="team-issues">
                    <div class="section-header">
                        <h2>ğŸ’¬ ãƒãƒ¼ãƒ å›°ã‚Šã”ã¨</h2>
                        <button id="addIssueBtn" class="update-btn">å›°ã‚Šã”ã¨ã‚’æŠ•ç¨¿</button>
                    </div>
                    <div class="issues-list" id="teamIssuesList">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- è² è·çŠ¶æ³æ›´æ–°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="workloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš¡ è² è·çŠ¶æ³ã‚’æ›´æ–°</h3>
                <button class="modal-close" id="workloadModalClose">&times;</button>
            </div>
            <form id="workloadForm" class="modal-form">
                <div class="form-group">
                    <label for="workloadLevelSelect">è² è·ãƒ¬ãƒ™ãƒ« *</label>
                    <div class="workload-level-selector">
                        <input type="radio" id="levelLow" name="workloadLevel" value="LOW" required>
                        <label for="levelLow" class="level-option level-low">
                            <span class="level-emoji">ğŸ˜Š</span>
                            <span class="level-text">ä½</span>
                        </label>
                        
                        <input type="radio" id="levelMedium" name="workloadLevel" value="MEDIUM">
                        <label for="levelMedium" class="level-option level-medium">
                            <span class="level-emoji">ğŸ˜</span>
                            <span class="level-text">ä¸­</span>
                        </label>
                        
                        <input type="radio" id="levelHigh" name="workloadLevel" value="HIGH">
                        <label for="levelHigh" class="level-option level-high">
                            <span class="level-emoji">ğŸ˜°</span>
                            <span class="level-text">é«˜</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectCount">æ‹…å½“æ¡ˆä»¶æ•°ï¼ˆä»»æ„ï¼‰</label>
                    <input type="number" id="projectCount" name="projectCount" min="0" max="20" 
                           placeholder="ä¾‹: 3">
                </div>

                <div class="form-group">
                    <label for="taskCount">é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯æ•°ï¼ˆä»»æ„ï¼‰</label>
                    <input type="number" id="taskCount" name="taskCount" min="0" max="100" 
                           placeholder="ä¾‹: 15">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="workloadCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn-primary">æ›´æ–°ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å›°ã‚Šã”ã¨æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="issueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’¬ å›°ã‚Šã”ã¨ã‚’æŠ•ç¨¿</h3>
                <button class="modal-close" id="issueModalClose">&times;</button>
            </div>
            <form id="issueForm" class="modal-form">
                <div class="form-group">
                    <label for="issueContent">å›°ã‚Šã”ã¨ãƒ»èª²é¡Œã®å†…å®¹ *</label>
                    <textarea id="issueContent" name="content" required 
                              placeholder="å›°ã£ã¦ã„ã‚‹ã“ã¨ã‚„èª²é¡Œã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚"
                              rows="6"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="issueCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    
    <!-- AWS Amplify CDN -->
    <script src="https://unpkg.com/@aws-amplify/core@5.8.5/dist/aws-amplify-core.min.js"></script>
    <script src="https://unpkg.com/@aws-amplify/auth@5.6.5/dist/aws-amplify-auth.min.js"></script>
    
    <!-- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="js/aws-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/authenticated-api-client.js"></script>
    <script src="js/realtime-client.js"></script>
    <script src="js/polling-client.js"></script>
    <script src="js/update-manager.js"></script>

    <script>
        // AWSç’°å¢ƒç”¨ã®APIè¨­å®š
        let API_BASE_URL = 'https://bn6xwu62qd.execute-api.ap-northeast-1.amazonaws.com/dev'; // ç›´æ¥API Gateway URL
        
        // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®å ´åˆã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            API_BASE_URL = 'http://localhost:8081/api';
        }

        console.log('API Base URL:', API_BASE_URL);

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        async function checkAuthentication() {
            try {
                const user = await authManager.getCurrentUser();
                if (!user) {
                    // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    console.log('èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                const userInfo = await authManager.getUserInfo();
                if (userInfo) {
                    const userInfoElement = document.getElementById('userInfo');
                    if (userInfoElement) {
                        const displayName = userInfo.name || userInfo.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                        userInfoElement.textContent = `ã“ã‚“ã«ã¡ã¯ã€${displayName}ã•ã‚“`;
                    }
                }
                
                console.log('èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', userInfo);
                return true;
            } catch (error) {
                console.error('èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = 'login.html';
                return false;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        async function logout() {
            try {
                const result = await authManager.signOut();
                if (result.success) {
                    console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
                    window.location.href = 'login.html';
                } else {
                    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', result.error);
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = 'login.html';
            }
        }
                
                return true;
            } catch (error) {
                console.error('èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        async function handleLogout() {
            try {
                await authManager.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                window.location.href = 'login.html';
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('AWSå¯¾å¿œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹');
            
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return;
            }
            
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('updateWorkloadBtn').addEventListener('click', openWorkloadModal);
            document.getElementById('addIssueBtn').addEventListener('click', openIssueModal);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
            initializeModals();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadDashboardData();
            
            // æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ï¼ˆWebSocketã¾ãŸã¯ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
            initializeUpdateSystem();
            
            console.log('AWSå¯¾å¿œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†');
        });

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadDashboardData() {
            await Promise.all([
                loadWorkloadStatus(),
                loadTeamIssues()
            ]);
        }

        // è² è·çŠ¶æ³èª­ã¿è¾¼ã¿
        async function loadWorkloadStatus() {
            try {
                console.log('è² è·çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const data = await apiClient.getWorkloadStatuses();
                console.log('è² è·çŠ¶æ³ãƒ‡ãƒ¼ã‚¿:', data);
                displayWorkloadStatus(data);
            } catch (error) {
                console.error('è² è·çŠ¶æ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: èªè¨¼ãªã—ã§è©¦è¡Œ
                try {
                    console.log('èªè¨¼ãªã—ã§APIå‘¼ã³å‡ºã—ã‚’è©¦è¡Œ...');
                    const response = await fetch(`${API_BASE_URL}/workload-status`);
                    if (response.ok) {
                        const data = await response.json();
                        displayWorkloadStatus(data);
                        return;
                    }
                } catch (fallbackError) {
                    console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:', fallbackError);
                }
                
                // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                console.log('ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                const mockData = [
                    {
                        userId: "user1",
                        displayName: "ç”°ä¸­å¤ªéƒ",
                        workloadLevel: "MEDIUM",
                        projectCount: 3,
                        taskCount: 15,
                        updatedAt: Date.now()
                    },
                    {
                        userId: "user2", 
                        displayName: "ä½è—¤èŠ±å­",
                        workloadLevel: "HIGH",
                        projectCount: 5,
                        taskCount: 25,
                        updatedAt: Date.now() - 3600000
                    },
                    {
                        userId: "user3",
                        displayName: "éˆ´æœ¨ä¸€éƒ",
                        workloadLevel: "LOW",
                        projectCount: 1,
                        taskCount: 5,
                        updatedAt: Date.now() - 7200000
                    }
                ];
                displayWorkloadStatus(mockData);
            }
        }

        // å›°ã‚Šã”ã¨èª­ã¿è¾¼ã¿
        async function loadTeamIssues() {
            try {
                console.log('å›°ã‚Šã”ã¨ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const data = await apiClient.getTeamIssues();
                console.log('å›°ã‚Šã”ã¨ãƒ‡ãƒ¼ã‚¿:', data);
                displayTeamIssues(data);
            } catch (error) {
                console.error('å›°ã‚Šã”ã¨èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: èªè¨¼ãªã—ã§è©¦è¡Œ
                try {
                    console.log('èªè¨¼ãªã—ã§APIå‘¼ã³å‡ºã—ã‚’è©¦è¡Œ...');
                    const response = await fetch(`${API_BASE_URL}/team-issues`);
                    if (response.ok) {
                        const data = await response.json();
                        displayTeamIssues(data);
                        return;
                    }
                } catch (fallbackError) {
                    console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:', fallbackError);
                }
                
                // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                console.log('ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                const mockData = [
                    {
                        issueId: "issue-1",
                        userId: "user1",
                        displayName: "ç”°ä¸­å¤ªéƒ",
                        content: "æ–°ã—ã„æŠ€è¡“ã®å­¦ç¿’ã§è©°ã¾ã£ã¦ã„ã¾ã™ã€‚React Hooksã®ä½¿ã„æ–¹ãŒã‚ˆãã‚ã‹ã‚‰ãšã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ç®¡ç†ã§å›°ã£ã¦ã„ã¾ã™ã€‚",
                        status: "OPEN",
                        priority: "HIGH",
                        createdAt: Date.now() - 86400000
                    },
                    {
                        issueId: "issue-2",
                        userId: "user2",
                        displayName: "ä½è—¤èŠ±å­", 
                        content: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²ã‚æ–¹ã§æ‚©ã‚“ã§ã„ã¾ã™ã€‚ã‚¿ã‚¹ã‚¯ã®å„ªå…ˆé †ä½ã‚’ã©ã†æ±ºã‚ã‚Œã°ã‚ˆã„ã‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚",
                        status: "RESOLVED",
                        priority: "MEDIUM",
                        createdAt: Date.now() - 172800000
                    }
                ];
                displayTeamIssues(mockData);
            }
        }

        // è² è·çŠ¶æ³è¡¨ç¤º
        function displayWorkloadStatus(statuses) {
            const container = document.getElementById('workloadStatusCards');
            container.innerHTML = '';

            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
            if (!Array.isArray(statuses)) {
                console.warn('è² è·çŠ¶æ³ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', statuses);
                container.innerHTML = '<div class="error">è² è·çŠ¶æ³ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                return;
            }

            statuses.forEach(status => {
                const card = document.createElement('div');
                card.className = `workload-card level-${status.workloadLevel}`;
                card.innerHTML = `
                    <div class="user-name">${status.displayName}</div>
                    <div class="workload-level">
                        <span class="workload-level-badge ${status.workloadLevel}">
                            ${getWorkloadLevelText(status.workloadLevel)}
                        </span>
                        <span>${getWorkloadLevelEmoji(status.workloadLevel)}</span>
                    </div>
                    <div class="workload-details">
                        ${status.projectCount ? `<div>ğŸ“ ${status.projectCount}æ¡ˆä»¶</div>` : ''}
                        ${status.taskCount ? `<div>ğŸ“‹ ${status.taskCount}ã‚¿ã‚¹ã‚¯</div>` : ''}
                    </div>
                    <div class="last-updated">æœ€çµ‚æ›´æ–°: ${formatDateTime(status.updatedAt)}</div>
                `;
                container.appendChild(card);
            });
        }

        // å›°ã‚Šã”ã¨è¡¨ç¤º
        function displayTeamIssues(issues) {
            const container = document.getElementById('teamIssuesList');
            container.innerHTML = '';

            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã®å‡¦ç†
            if (!Array.isArray(issues)) {
                console.warn('å›°ã‚Šã”ã¨ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', issues);
                container.innerHTML = '<div class="error">å›°ã‚Šã”ã¨ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                return;
            }

            issues.forEach(issue => {
                const item = document.createElement('div');
                item.className = `issue-item ${issue.status.toLowerCase()}`;
                item.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-author">
                            <span class="name">${issue.displayName}</span>
                            <span class="date">${formatDateTime(issue.createdAt)}</span>
                        </div>
                        <div class="issue-status">
                            <span class="status-badge ${issue.status}">
                                ${issue.status === 'OPEN' ? 'æœªè§£æ±º' : 'è§£æ±ºæ¸ˆã¿'}
                            </span>
                        </div>
                    </div>
                    <div class="issue-content">${issue.content}</div>
                `;
                container.appendChild(item);
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–
        function initializeModals() {
            // è² è·çŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ«
            const workloadModal = document.getElementById('workloadModal');
            const workloadForm = document.getElementById('workloadForm');
            
            document.getElementById('workloadModalClose').addEventListener('click', () => {
                workloadModal.classList.remove('show');
            });
            
            document.getElementById('workloadCancelBtn').addEventListener('click', () => {
                workloadModal.classList.remove('show');
            });
            
            workloadForm.addEventListener('submit', handleWorkloadSubmit);

            // å›°ã‚Šã”ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«
            const issueModal = document.getElementById('issueModal');
            const issueForm = document.getElementById('issueForm');
            
            document.getElementById('issueModalClose').addEventListener('click', () => {
                issueModal.classList.remove('show');
            });
            
            document.getElementById('issueCancelBtn').addEventListener('click', () => {
                issueModal.classList.remove('show');
            });
            
            issueForm.addEventListener('submit', handleIssueSubmit);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openWorkloadModal() {
            console.log('è² è·çŠ¶æ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã™');
            document.getElementById('workloadModal').classList.add('show');
        }

        function openIssueModal() {
            console.log('å›°ã‚Šã”ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã™');
            document.getElementById('issueModal').classList.add('show');
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        async function handleWorkloadSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                workloadLevel: formData.get('workloadLevel')
            };
            
            if (formData.get('projectCount')) {
                data.projectCount = parseInt(formData.get('projectCount'));
            }
            
            if (formData.get('taskCount')) {
                data.taskCount = parseInt(formData.get('taskCount'));
            }

            try {
                const response = await fetch(`${API_BASE_URL}/workload-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification('è² è·çŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    document.getElementById('workloadModal').classList.remove('show');
                    event.target.reset();
                    loadWorkloadStatus();
                } else {
                    throw new Error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('è² è·çŠ¶æ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        async function handleIssueSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                content: formData.get('content')
            };

            try {
                const response = await fetch(`${API_BASE_URL}/team-issues`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification('å›°ã‚Šã”ã¨ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ', 'success');
                    document.getElementById('issueModal').classList.remove('show');
                    event.target.reset();
                    loadTeamIssues();
                } else {
                    throw new Error('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('å›°ã‚Šã”ã¨æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getWorkloadLevelText(level) {
            const texts = { 'LOW': 'ä½', 'MEDIUM': 'ä¸­', 'HIGH': 'é«˜' };
            return texts[level] || 'æœªè¨­å®š';
        }

        function getWorkloadLevelEmoji(level) {
            const emojis = { 'LOW': 'ğŸ˜Š', 'MEDIUM': 'ğŸ˜', 'HIGH': 'ğŸ˜°' };
            return emojis[level] || 'â“';
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffMins < 1) return 'ãŸã£ãŸä»Š';
            if (diffMins < 60) return `${diffMins}åˆ†å‰`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}æ™‚é–“å‰`;
            return date.toLocaleDateString('ja-JP');
        }

        // æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆWebSocketã¾ãŸã¯ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
        async function initializeUpdateSystem() {
            console.log('æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...');
            
            try {
                // UpdateManagerã‚’åˆæœŸåŒ–ï¼ˆè‡ªå‹•çš„ã«WebSocketã¾ãŸã¯ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é¸æŠï¼‰
                await updateManager.initialize();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç™»éŒ²
                updateManager.on('workload-update', (data) => {
                    console.log('è² è·çŠ¶æ³æ›´æ–°:', data);
                    // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®å‡¦ç†
                });

                updateManager.on('issue-update', (data) => {
                    console.log('å›°ã‚Šã”ã¨æ›´æ–°:', data);
                    // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®å‡¦ç†
                });

                // æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                addManualUpdateButton();
                
            } catch (error) {
                console.error('æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        function addManualUpdateButton() {
            const headerRight = document.querySelector('.header-right');
            if (headerRight && !document.getElementById('manualUpdateBtn')) {
                const updateBtn = document.createElement('button');
                updateBtn.id = 'manualUpdateBtn';
                updateBtn.className = 'manual-update-btn';
                updateBtn.innerHTML = 'ğŸ”„';
                updateBtn.title = 'æ‰‹å‹•æ›´æ–°';
                updateBtn.addEventListener('click', async () => {
                    updateBtn.disabled = true;
                    updateBtn.innerHTML = 'â³';
                    try {
                        await updateManager.manualUpdate();
                    } finally {
                        updateBtn.disabled = false;
                        updateBtn.innerHTML = 'ğŸ”„';
                    }
                });
                
                // æ¥ç¶šçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®å‰ã«æŒ¿å…¥
                const connectionStatus = document.getElementById('connectionStatus');
                headerRight.insertBefore(updateBtn, connectionStatus);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>