<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チーム状況ダッシュボード</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/realtime.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🎯 チーム状況ダッシュボード</h1>
            <div class="header-right">
                <span id="connectionStatus" class="connection-status">🔴 接続中...</span>
                <span id="userInfo" class="user-info"></span>
                <button id="logoutBtn" class="logout-btn">ログアウト</button>
            </div>
            <nav class="nav">
                <button class="nav-btn active" data-tab="dashboard">ダッシュボード</button>
                <button class="nav-btn" data-tab="report">日報投稿</button>
                <button class="nav-btn" data-tab="calendar">カレンダー</button>
            </nav>
        </header>

        <main class="main">
            <div class="dashboard-grid">
                <!-- 負荷状況セクション -->
                <section class="workload-status">
                    <div class="section-header">
                        <h2>⚡ チーム負荷状況</h2>
                        <button id="updateWorkloadBtn" class="update-btn">負荷状況を更新</button>
                    </div>
                    <div class="workload-cards" id="workloadStatusCards">
                        <!-- 動的に生成 -->
                    </div>
                </section>

                <!-- 困りごとセクション -->
                <section class="team-issues">
                    <div class="section-header">
                        <h2>💬 チーム困りごと</h2>
                        <button id="addIssueBtn" class="update-btn">困りごとを投稿</button>
                    </div>
                    <div class="issues-list" id="teamIssuesList">
                        <!-- 動的に生成 -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- 負荷状況更新モーダル -->
    <div id="workloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚡ 負荷状況を更新</h3>
                <button class="modal-close" id="workloadModalClose">&times;</button>
            </div>
            <form id="workloadForm" class="modal-form">
                <div class="form-group">
                    <label for="workloadLevelSelect">負荷レベル *</label>
                    <div class="workload-level-selector">
                        <input type="radio" id="levelLow" name="workloadLevel" value="LOW" required>
                        <label for="levelLow" class="level-option level-low">
                            <span class="level-emoji">😊</span>
                            <span class="level-text">低</span>
                        </label>
                        
                        <input type="radio" id="levelMedium" name="workloadLevel" value="MEDIUM">
                        <label for="levelMedium" class="level-option level-medium">
                            <span class="level-emoji">😐</span>
                            <span class="level-text">中</span>
                        </label>
                        
                        <input type="radio" id="levelHigh" name="workloadLevel" value="HIGH">
                        <label for="levelHigh" class="level-option level-high">
                            <span class="level-emoji">😰</span>
                            <span class="level-text">高</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectCount">担当案件数（任意）</label>
                    <input type="number" id="projectCount" name="projectCount" min="0" max="20" 
                           placeholder="例: 3">
                </div>

                <div class="form-group">
                    <label for="taskCount">進行中タスク数（任意）</label>
                    <input type="number" id="taskCount" name="taskCount" min="0" max="100" 
                           placeholder="例: 15">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="workloadCancelBtn">キャンセル</button>
                    <button type="submit" class="btn-primary">更新する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 困りごと投稿モーダル -->
    <div id="issueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💬 困りごとを投稿</h3>
                <button class="modal-close" id="issueModalClose">&times;</button>
            </div>
            <form id="issueForm" class="modal-form">
                <div class="form-group">
                    <label for="issueContent">困りごと・課題の内容 *</label>
                    <textarea id="issueContent" name="content" required 
                              placeholder="困っていることや課題について詳しく教えてください。"
                              rows="6"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="issueCancelBtn">キャンセル</button>
                    <button type="submit" class="btn-primary">投稿する</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    
    <!-- AWS Amplify CDN -->
    <script src="https://unpkg.com/@aws-amplify/core@5.8.5/dist/aws-amplify-core.min.js"></script>
    <script src="https://unpkg.com/@aws-amplify/auth@5.6.5/dist/aws-amplify-auth.min.js"></script>
    
    <!-- 設定ファイル -->
    <script src="js/aws-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/authenticated-api-client.js"></script>
    <script src="js/realtime-client.js"></script>
    <script src="js/polling-client.js"></script>
    <script src="js/update-manager.js"></script>

    <script>
        // AWS環境用のAPI設定
        let API_BASE_URL = 'https://bn6xwu62qd.execute-api.ap-northeast-1.amazonaws.com/dev'; // 直接API Gateway URL
        
        // ローカル開発の場合のみローカルサーバーを使用
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            API_BASE_URL = 'http://localhost:8081/api';
        }

        console.log('API Base URL:', API_BASE_URL);

        // 認証チェック
        async function checkAuthentication() {
            try {
                const user = await authManager.getCurrentUser();
                if (!user) {
                    // 認証されていない場合はログインページにリダイレクト
                    console.log('認証されていません。ログインページにリダイレクトします。');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // ユーザー情報を表示
                const userInfo = await authManager.getUserInfo();
                if (userInfo) {
                    const userInfoElement = document.getElementById('userInfo');
                    if (userInfoElement) {
                        const displayName = userInfo.name || userInfo.username || 'ユーザー';
                        userInfoElement.textContent = `こんにちは、${displayName}さん`;
                    }
                }
                
                console.log('認証済みユーザー:', userInfo);
                return true;
            } catch (error) {
                console.error('認証チェックエラー:', error);
                // エラーの場合もログインページにリダイレクト
                window.location.href = 'login.html';
                return false;
            }
        }

        // ログアウト機能
        async function logout() {
            try {
                const result = await authManager.signOut();
                if (result.success) {
                    console.log('ログアウト成功');
                    window.location.href = 'login.html';
                } else {
                    console.error('ログアウトエラー:', result.error);
                }
            } catch (error) {
                console.error('ログアウトエラー:', error);
                // エラーでもログインページにリダイレクト
                window.location.href = 'login.html';
            }
        }
                
                return true;
            } catch (error) {
                console.error('認証チェックエラー:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // ログアウト処理
        async function handleLogout() {
            try {
                await authManager.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ログアウトエラー:', error);
                window.location.href = 'login.html';
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('AWS対応ダッシュボード初期化開始');
            
            // 認証チェック
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return;
            }
            
            // ログアウトボタンのイベントリスナー
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ボタンイベントリスナー
            document.getElementById('updateWorkloadBtn').addEventListener('click', openWorkloadModal);
            document.getElementById('addIssueBtn').addEventListener('click', openIssueModal);
            
            // モーダル関連
            initializeModals();
            
            // データ読み込み
            loadDashboardData();
            
            // 更新システムを初期化（WebSocketまたはポーリング）
            initializeUpdateSystem();
            
            console.log('AWS対応ダッシュボード初期化完了');
        });

        // ダッシュボードデータ読み込み
        async function loadDashboardData() {
            await Promise.all([
                loadWorkloadStatus(),
                loadTeamIssues()
            ]);
        }

        // 負荷状況読み込み
        async function loadWorkloadStatus() {
            try {
                console.log('負荷状況を読み込み中...');
                const data = await apiClient.getWorkloadStatuses();
                console.log('負荷状況データ:', data);
                displayWorkloadStatus(data);
            } catch (error) {
                console.error('負荷状況読み込みエラー:', error);
                
                // フォールバック: 認証なしで試行
                try {
                    console.log('認証なしでAPI呼び出しを試行...');
                    const response = await fetch(`${API_BASE_URL}/workload-status`);
                    if (response.ok) {
                        const data = await response.json();
                        displayWorkloadStatus(data);
                        return;
                    }
                } catch (fallbackError) {
                    console.error('フォールバックも失敗:', fallbackError);
                }
                
                // 最終フォールバック: モックデータを使用
                console.log('モックデータを使用します');
                const mockData = [
                    {
                        userId: "user1",
                        displayName: "田中太郎",
                        workloadLevel: "MEDIUM",
                        projectCount: 3,
                        taskCount: 15,
                        updatedAt: Date.now()
                    },
                    {
                        userId: "user2", 
                        displayName: "佐藤花子",
                        workloadLevel: "HIGH",
                        projectCount: 5,
                        taskCount: 25,
                        updatedAt: Date.now() - 3600000
                    },
                    {
                        userId: "user3",
                        displayName: "鈴木一郎",
                        workloadLevel: "LOW",
                        projectCount: 1,
                        taskCount: 5,
                        updatedAt: Date.now() - 7200000
                    }
                ];
                displayWorkloadStatus(mockData);
            }
        }

        // 困りごと読み込み
        async function loadTeamIssues() {
            try {
                console.log('困りごとを読み込み中...');
                const data = await apiClient.getTeamIssues();
                console.log('困りごとデータ:', data);
                displayTeamIssues(data);
            } catch (error) {
                console.error('困りごと読み込みエラー:', error);
                
                // フォールバック: 認証なしで試行
                try {
                    console.log('認証なしでAPI呼び出しを試行...');
                    const response = await fetch(`${API_BASE_URL}/team-issues`);
                    if (response.ok) {
                        const data = await response.json();
                        displayTeamIssues(data);
                        return;
                    }
                } catch (fallbackError) {
                    console.error('フォールバックも失敗:', fallbackError);
                }
                
                // 最終フォールバック: モックデータを使用
                console.log('モックデータを使用します');
                const mockData = [
                    {
                        issueId: "issue-1",
                        userId: "user1",
                        displayName: "田中太郎",
                        content: "新しい技術の学習で詰まっています。React Hooksの使い方がよくわからず、コンポーネントの状態管理で困っています。",
                        status: "OPEN",
                        priority: "HIGH",
                        createdAt: Date.now() - 86400000
                    },
                    {
                        issueId: "issue-2",
                        userId: "user2",
                        displayName: "佐藤花子", 
                        content: "プロジェクトの進め方で悩んでいます。タスクの優先順位をどう決めればよいかアドバイスをください。",
                        status: "RESOLVED",
                        priority: "MEDIUM",
                        createdAt: Date.now() - 172800000
                    }
                ];
                displayTeamIssues(mockData);
            }
        }

        // 負荷状況表示
        function displayWorkloadStatus(statuses) {
            const container = document.getElementById('workloadStatusCards');
            container.innerHTML = '';

            // データが配列でない場合の処理
            if (!Array.isArray(statuses)) {
                console.warn('負荷状況データが配列ではありません:', statuses);
                container.innerHTML = '<div class="error">負荷状況データの形式が正しくありません。</div>';
                return;
            }

            statuses.forEach(status => {
                const card = document.createElement('div');
                card.className = `workload-card level-${status.workloadLevel}`;
                card.innerHTML = `
                    <div class="user-name">${status.displayName}</div>
                    <div class="workload-level">
                        <span class="workload-level-badge ${status.workloadLevel}">
                            ${getWorkloadLevelText(status.workloadLevel)}
                        </span>
                        <span>${getWorkloadLevelEmoji(status.workloadLevel)}</span>
                    </div>
                    <div class="workload-details">
                        ${status.projectCount ? `<div>📁 ${status.projectCount}案件</div>` : ''}
                        ${status.taskCount ? `<div>📋 ${status.taskCount}タスク</div>` : ''}
                    </div>
                    <div class="last-updated">最終更新: ${formatDateTime(status.updatedAt)}</div>
                `;
                container.appendChild(card);
            });
        }

        // 困りごと表示
        function displayTeamIssues(issues) {
            const container = document.getElementById('teamIssuesList');
            container.innerHTML = '';

            // データが配列でない場合の処理
            if (!Array.isArray(issues)) {
                console.warn('困りごとデータが配列ではありません:', issues);
                container.innerHTML = '<div class="error">困りごとデータの形式が正しくありません。</div>';
                return;
            }

            issues.forEach(issue => {
                const item = document.createElement('div');
                item.className = `issue-item ${issue.status.toLowerCase()}`;
                item.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-author">
                            <span class="name">${issue.displayName}</span>
                            <span class="date">${formatDateTime(issue.createdAt)}</span>
                        </div>
                        <div class="issue-status">
                            <span class="status-badge ${issue.status}">
                                ${issue.status === 'OPEN' ? '未解決' : '解決済み'}
                            </span>
                        </div>
                    </div>
                    <div class="issue-content">${issue.content}</div>
                `;
                container.appendChild(item);
            });
        }

        // モーダル初期化
        function initializeModals() {
            // 負荷状況モーダル
            const workloadModal = document.getElementById('workloadModal');
            const workloadForm = document.getElementById('workloadForm');
            
            document.getElementById('workloadModalClose').addEventListener('click', () => {
                workloadModal.classList.remove('show');
            });
            
            document.getElementById('workloadCancelBtn').addEventListener('click', () => {
                workloadModal.classList.remove('show');
            });
            
            workloadForm.addEventListener('submit', handleWorkloadSubmit);

            // 困りごとモーダル
            const issueModal = document.getElementById('issueModal');
            const issueForm = document.getElementById('issueForm');
            
            document.getElementById('issueModalClose').addEventListener('click', () => {
                issueModal.classList.remove('show');
            });
            
            document.getElementById('issueCancelBtn').addEventListener('click', () => {
                issueModal.classList.remove('show');
            });
            
            issueForm.addEventListener('submit', handleIssueSubmit);
        }

        // モーダル開く
        function openWorkloadModal() {
            console.log('負荷状況モーダルを開きます');
            document.getElementById('workloadModal').classList.add('show');
        }

        function openIssueModal() {
            console.log('困りごとモーダルを開きます');
            document.getElementById('issueModal').classList.add('show');
        }

        // フォーム送信処理
        async function handleWorkloadSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                workloadLevel: formData.get('workloadLevel')
            };
            
            if (formData.get('projectCount')) {
                data.projectCount = parseInt(formData.get('projectCount'));
            }
            
            if (formData.get('taskCount')) {
                data.taskCount = parseInt(formData.get('taskCount'));
            }

            try {
                const response = await fetch(`${API_BASE_URL}/workload-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification('負荷状況を更新しました', 'success');
                    document.getElementById('workloadModal').classList.remove('show');
                    event.target.reset();
                    loadWorkloadStatus();
                } else {
                    throw new Error('更新に失敗しました');
                }
            } catch (error) {
                console.error('負荷状況更新エラー:', error);
                showNotification('更新に失敗しました', 'error');
            }
        }

        async function handleIssueSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                content: formData.get('content')
            };

            try {
                const response = await fetch(`${API_BASE_URL}/team-issues`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification('困りごとを投稿しました', 'success');
                    document.getElementById('issueModal').classList.remove('show');
                    event.target.reset();
                    loadTeamIssues();
                } else {
                    throw new Error('投稿に失敗しました');
                }
            } catch (error) {
                console.error('困りごと投稿エラー:', error);
                showNotification('投稿に失敗しました', 'error');
            }
        }

        // ユーティリティ関数
        function getWorkloadLevelText(level) {
            const texts = { 'LOW': '低', 'MEDIUM': '中', 'HIGH': '高' };
            return texts[level] || '未設定';
        }

        function getWorkloadLevelEmoji(level) {
            const emojis = { 'LOW': '😊', 'MEDIUM': '😐', 'HIGH': '😰' };
            return emojis[level] || '❓';
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffMins < 1) return 'たった今';
            if (diffMins < 60) return `${diffMins}分前`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}時間前`;
            return date.toLocaleDateString('ja-JP');
        }

        // 更新システムの初期化（WebSocketまたはポーリング）
        async function initializeUpdateSystem() {
            console.log('更新システムを初期化中...');
            
            try {
                // UpdateManagerを初期化（自動的にWebSocketまたはポーリングを選択）
                await updateManager.initialize();
                
                // イベントハンドラーを登録
                updateManager.on('workload-update', (data) => {
                    console.log('負荷状況更新:', data);
                    // 必要に応じて追加の処理
                });

                updateManager.on('issue-update', (data) => {
                    console.log('困りごと更新:', data);
                    // 必要に応じて追加の処理
                });

                // 手動更新ボタンを追加
                addManualUpdateButton();
                
            } catch (error) {
                console.error('更新システム初期化エラー:', error);
                showNotification('更新システムの初期化に失敗しました', 'error');
            }
        }

        // 手動更新ボタンを追加
        function addManualUpdateButton() {
            const headerRight = document.querySelector('.header-right');
            if (headerRight && !document.getElementById('manualUpdateBtn')) {
                const updateBtn = document.createElement('button');
                updateBtn.id = 'manualUpdateBtn';
                updateBtn.className = 'manual-update-btn';
                updateBtn.innerHTML = '🔄';
                updateBtn.title = '手動更新';
                updateBtn.addEventListener('click', async () => {
                    updateBtn.disabled = true;
                    updateBtn.innerHTML = '⏳';
                    try {
                        await updateManager.manualUpdate();
                    } finally {
                        updateBtn.disabled = false;
                        updateBtn.innerHTML = '🔄';
                    }
                });
                
                // 接続状態インジケーターの前に挿入
                const connectionStatus = document.getElementById('connectionStatus');
                headerRight.insertBefore(updateBtn, connectionStatus);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>